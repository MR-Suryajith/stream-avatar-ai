<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stream Overlay</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
:root {
  --purple: #a259ff;
  --blue:   #38d9f5;
  --gold:   #f5c842;
}
body {
  background: transparent;
  width: 100vw; height: 100vh;
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
}

/* â”€â”€ AI IMAGE PANEL (bottom strip) â”€â”€ */
#ai-panel {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 190px;
  display: flex;
  align-items: center;
  z-index: 100;
  pointer-events: none;
  overflow: hidden;
}
#ai-panel::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(to top,
    rgba(4,4,12,.97) 0%,
    rgba(4,4,12,.88) 55%,
    transparent 100%);
  z-index: 0;
}

.ai-slot {
  position: relative;
  z-index: 1;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 20px;
  opacity: 0;
  transform: translateY(40px);
  animation: slideUp .6s cubic-bezier(.34,1.56,.64,1) forwards;
}
.ai-slot.out {
  animation: slideDown .45s ease-in forwards !important;
}
@keyframes slideUp   { to { opacity:1; transform:translateY(0); } }
@keyframes slideDown { to { opacity:0; transform:translateY(24px); } }

/* â”€â”€ IMAGE BOX â”€â”€ */
.ai-thumb-wrap {
  position: relative;
  flex-shrink: 0;
  width: 148px;
  height: 148px;
}

/* Spinning glow ring â€” always visible */
.ai-glow {
  position: absolute;
  inset: -6px;
  border-radius: 22px;
  background: conic-gradient(#a259ff, #38d9f5, #f5c842, #a259ff);
  opacity: .6;
  z-index: -1;
  filter: blur(4px);
  animation: spin 3s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Loading placeholder while Pollinations generates */
.ai-loading-box {
  width: 148px; height: 148px;
  border-radius: 18px;
  border: 2px solid rgba(162,89,255,.5);
  background: rgba(162,89,255,.08);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  overflow: hidden;
  position: relative;
}

/* Scanning line animation */
.ai-loading-box::after {
  content: '';
  position: absolute;
  top: -100%;
  left: 0; right: 0;
  height: 40%;
  background: linear-gradient(to bottom,
    transparent,
    rgba(162,89,255,.15),
    rgba(56,217,245,.1),
    transparent);
  animation: scan 2s ease-in-out infinite;
}
@keyframes scan {
  0%   { top: -40%; }
  100% { top: 110%; }
}

.ai-loading-icon {
  font-size: 28px;
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }

.ai-loading-text {
  font-family: 'Syne', sans-serif;
  font-size: 8px;
  letter-spacing: 2px;
  color: rgba(162,89,255,.7);
  text-transform: uppercase;
}

/* Progress bar */
.ai-progress-wrap {
  position: absolute;
  bottom: 10px; left: 12px; right: 12px;
  height: 3px;
  background: rgba(255,255,255,.08);
  border-radius: 2px;
  overflow: hidden;
}
.ai-progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #a259ff, #38d9f5);
  border-radius: 2px;
  transition: width .5s ease;
}

/* Actual image â€” hidden until loaded */
.ai-thumb {
  width: 148px; height: 148px;
  border-radius: 18px;
  object-fit: cover;
  display: none;
  border: 2px solid rgba(162,89,255,.6);
  box-shadow: 0 0 28px rgba(162,89,255,.4), 0 8px 28px rgba(0,0,0,.7);
}
.ai-thumb.visible { display: block; }

/* â”€â”€ TEXT â”€â”€ */
.ai-meta {
  display: flex;
  flex-direction: column;
  gap: 5px;
  max-width: 260px;
}
.ai-tag {
  font-family: 'Syne', sans-serif;
  font-size: 9px;
  letter-spacing: 3.5px;
  color: var(--purple);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 6px;
}
.ai-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--purple);
  animation: blink 1.1s ease-in-out infinite;
  flex-shrink: 0;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }
.ai-username {
  font-family: 'Syne', sans-serif;
  font-size: 26px;
  font-weight: 800;
  color: #fff;
  line-height: 1;
}
.ai-prompt {
  font-size: 13px;
  color: rgba(255,255,255,.55);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  font-style: italic;
}
.ai-status {
  font-size: 11px;
  color: rgba(56,217,245,.7);
  letter-spacing: .5px;
  margin-top: 2px;
}

/* Queue + conn */
#ai-queue-badge {
  position: fixed; bottom: 198px; left: 20px;
  font-family: 'Syne', sans-serif; font-size: 10px;
  letter-spacing: 2px; color: rgba(162,89,255,.65);
  z-index: 101; pointer-events: none;
}
#conn-dot {
  position: fixed; top: 10px; right: 10px;
  width: 7px; height: 7px; border-radius: 50%;
  background: #ff4f4f; z-index: 300; pointer-events: none;
  transition: background .4s;
}
#conn-dot.ok { background: #3ddc84; box-shadow: 0 0 7px #3ddc84; }

/* Ticker */
#ticker-bar {
  position: fixed; top: 0; left: 0; right: 0; height: 26px;
  background: linear-gradient(90deg, rgba(162,89,255,.12), rgba(56,217,245,.06), rgba(162,89,255,.12));
  border-bottom: 1px solid rgba(162,89,255,.18);
  display: flex; align-items: center; overflow: hidden;
  z-index: 200; pointer-events: none;
}
.ticker-text {
  white-space: nowrap; font-family: 'Syne', sans-serif;
  font-size: 9px; letter-spacing: 3px; color: rgba(255,255,255,.35);
  animation: ticker 22s linear infinite;
}
@keyframes ticker { from{transform:translateX(100vw)} to{transform:translateX(-100%)} }
</style>
</head>
<body>

<div id="ticker-bar">
  <span class="ticker-text">
    âœ¦ TYPE !generate [your prompt] IN CHAT TO CREATE AI ART ON STREAM &nbsp;&nbsp;&nbsp;&nbsp;
    âœ¦ TYPE !generate [your prompt] IN CHAT TO CREATE AI ART ON STREAM &nbsp;&nbsp;&nbsp;&nbsp;
  </span>
</div>

<div id="ai-panel"></div>
<div id="ai-queue-badge"></div>
<div id="conn-dot"></div>

<script>
const BASE_URL = 'https://stream-avatar.netlify.app';
const POLL_MS  = 3000;

const aiPanel    = document.getElementById('ai-panel');
const queueBadge = document.getElementById('ai-queue-badge');
const connDot    = document.getElementById('conn-dot');

let aiQueue   = [];
let aiShowing = false;

function setConn(ok) { connDot.className = ok ? 'ok' : ''; }
function updateBadge() { queueBadge.textContent = aiQueue.length > 0 ? `+${aiQueue.length} in queue` : ''; }

function esc(s) {
  return String(s || '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showNextAI() {
  if (aiShowing || aiQueue.length === 0) return;
  aiShowing = true;
  displayAICard(aiQueue.shift());
  updateBadge();
}

function displayAICard(item) {
  // Remove existing cards
  Array.from(aiPanel.querySelectorAll('.ai-slot')).forEach(s => {
    s.classList.add('out');
    setTimeout(() => s.remove(), 450);
  });

  const slot = document.createElement('div');
  slot.className = 'ai-slot';
  slot.innerHTML = `
    <div class="ai-thumb-wrap">
      <div class="ai-glow"></div>
      <div class="ai-loading-box" id="loading-${item.id}">
        <div class="ai-loading-icon">ðŸŽ¨</div>
        <div class="ai-loading-text">Generating...</div>
        <div class="ai-progress-wrap">
          <div class="ai-progress-bar" id="progress-${item.id}"></div>
        </div>
      </div>
      <img class="ai-thumb" id="img-${item.id}" alt="${esc(item.prompt)}"/>
    </div>
    <div class="ai-meta">
      <div class="ai-tag"><span class="ai-dot"></span>AI Generated</div>
      <div class="ai-username">${esc(item.username)}</div>
      <div class="ai-prompt">"${esc(item.prompt)}"</div>
      <div class="ai-status" id="status-${item.id}">Generating image...</div>
    </div>`;
  aiPanel.appendChild(slot);

  const imgEl      = slot.querySelector(`#img-${item.id}`);
  const loadingBox = slot.querySelector(`#loading-${item.id}`);
  const progressEl = slot.querySelector(`#progress-${item.id}`);
  const statusEl   = slot.querySelector(`#status-${item.id}`);

  // Animate progress bar over 25 seconds
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress = Math.min(progress + (100 / 50), 92); // never hits 100 until loaded
    progressEl.style.width = progress + '%';
  }, 500);

  // Update status text over time
  const statusMessages = [
    { t: 3000,  msg: 'Processing prompt...' },
    { t: 8000,  msg: 'Painting details...' },
    { t: 15000, msg: 'Almost ready...' },
    { t: 22000, msg: 'Finishing touches...' },
  ];
  const statusTimers = statusMessages.map(({ t, msg }) =>
    setTimeout(() => { if (statusEl) statusEl.textContent = msg; }, t)
  );

  // Load image â€” give Pollinations up to 45 seconds
  let loaded = false;
  const TIMEOUT_MS = 45000;

  function onImageLoaded() {
    if (loaded) return;
    loaded = true;
    clearInterval(progressInterval);
    statusTimers.forEach(clearTimeout);
    progressEl.style.width = '100%';
    setTimeout(() => {
      loadingBox.style.display = 'none';
      imgEl.src = item.imageUrl;
      imgEl.classList.add('visible');
      if (statusEl) statusEl.textContent = 'Done!';
    }, 300);
  }

  function onImageFailed() {
    if (loaded) return;
    loaded = true;
    clearInterval(progressInterval);
    statusTimers.forEach(clearTimeout);
    if (statusEl) statusEl.textContent = 'Generation failed';
    loadingBox.querySelector('.ai-loading-icon').textContent = 'âŒ';
  }

  // Poll the image URL until it loads (Pollinations needs time)
  let attempts  = 0;
  const MAX_ATT = 15; // try every 3s for 45s total

  function tryLoadImage() {
    if (loaded || attempts >= MAX_ATT) {
      if (!loaded) onImageFailed();
      return;
    }
    attempts++;
    const testImg = new Image();
    testImg.onload  = onImageLoaded;
    testImg.onerror = () => setTimeout(tryLoadImage, 3000); // retry in 3s
    testImg.src     = item.imageUrl + `&_t=${attempts}`; // bust cache
  }

  tryLoadImage();

  // Show card for 20 seconds AFTER image loads, or 60s total max
  const DISPLAY_MS   = 20000;
  const TOTAL_MAX_MS = 60000;
  let   displayTimer = null;

  imgEl.addEventListener('load', () => {
    clearTimeout(displayTimer);
    displayTimer = setTimeout(dismiss, DISPLAY_MS);
  });

  // Failsafe: dismiss after 60s no matter what
  setTimeout(dismiss, TOTAL_MAX_MS);

  function dismiss() {
    if (!slot.parentNode) return;
    clearInterval(progressInterval);
    statusTimers.forEach(clearTimeout);
    slot.classList.add('out');
    setTimeout(() => {
      slot.remove();
      aiShowing = false;
      showNextAI();
    }, 450);
  }
}

async function pollAIImages() {
  try {
    const r = await fetch(`${BASE_URL}/.netlify/functions/poll-images`, { cache: 'no-store' });
    const d = await r.json();
    setConn(true);
    if (d.item) {
      aiQueue.push(d.item);
      updateBadge();
      showNextAI();
    }
  } catch (_) { setConn(false); }
}

// Start immediately then repeat
pollAIImages();
setInterval(pollAIImages, POLL_MS);
</script>
</body>
</html>