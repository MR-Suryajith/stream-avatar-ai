<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stream Overlay</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body { background:transparent; width:100vw; height:100vh; overflow:hidden; font-family:'DM Sans',sans-serif; display: flex; align-items: center; justify-content: center; }

#ai-panel {
  position:relative; width: 512px; height: 512px;
  display:flex; align-items:center; justify-content: center;
}

.ai-slot {
  position:relative; display:flex; flex-direction:column; align-items:center; justify-content: center;
  opacity:0; transform:scale(0.8);
  animation:popIn .6s cubic-bezier(.34,1.56,.64,1) forwards;
}
.ai-slot.out { animation:popOut .45s ease-in forwards !important; }
@keyframes popIn   { to { opacity:1; transform:scale(1); } }
@keyframes popOut { to { opacity:0; transform:scale(0.8); } }

/* Image wrap */
.ai-thumb-wrap { position:relative; width:400px; height:400px; }

/* Actual image */
.ai-thumb {
  width:100%; height:100%; border-radius:32px; object-fit:cover;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  border: 4px solid rgba(255,255,255,0.2);
}

/* User Name Label */
.ai-username {
  margin-top: 20px;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  padding: 10px 24px;
  border-radius: 50px;
  font-family:'Syne',sans-serif;
  font-size: 24px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Loading Spinner (Optional, simple) */
.ai-loading-text {
  position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  color: white; font-family: sans-serif; opacity: 0.5;
}
</style>
</head>
<body>

<div id="ai-panel"></div>

<script>
const POLL_MS  = 3000;

const aiPanel  = document.getElementById('ai-panel');
let aiQueue   = [];
let aiShowing = false;

function esc(s) {
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showNextAI() {
  if (aiShowing || aiQueue.length === 0) return;
  aiShowing = true;
  displayAICard(aiQueue.shift());
}

function displayAICard(item) {
  // Clear old
  aiPanel.innerHTML = '';

  const slot = document.createElement('div');
  slot.className = 'ai-slot';
  slot.innerHTML = `
    <div class="ai-thumb-wrap">
      <img class="ai-thumb" id="img-${item.id}" alt="AI Art"/>
    </div>
    <div class="ai-username">${esc(item.username)}</div>
  `;
  aiPanel.appendChild(slot);

  const imgEl = slot.querySelector(`#img-${item.id}`);

  // Image ready
  imgEl.onload = () => {
     // Show for 20s then dismiss
     setTimeout(dismiss, 20000);
  };

  imgEl.onerror = () => {
    // Retry once after 3s
    setTimeout(() => { imgEl.src = item.imageUrl + '&_r=' + Date.now(); }, 3000);
  };

  imgEl.src = item.imageUrl;

  // Cleanup function
  function dismiss() {
    if (!slot.parentNode) return;
    slot.classList.add('out');
    setTimeout(() => {
        slot.remove();
        aiShowing = false;
        showNextAI();
    }, 450);
  }
}

async function pollAIImages() {
  try {
    const r = await fetch(`/.netlify/functions/poll-images`, { cache:'no-store' });
    const d = await r.json();
    if (d.item) {
      aiQueue.push(d.item);
      showNextAI();
    }
  } catch (_) {}
}

setInterval(pollAIImages, POLL_MS);
</script>
</body>
</html>